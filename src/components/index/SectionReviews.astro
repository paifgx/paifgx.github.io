---
import { caseStudies, getTotalSlides } from "../../content/caseStudies";

const totalSlides = getTotalSlides();
---

<div class="mb-12 max-w-4xl">
  <p class="text-sm font-semibold uppercase tracking-widest text-brand-gold">
    Referenzen
  </p>
  <h2
    id="case-studies-heading"
    class="mt-2 text-3xl font-bold text-gray-900 dark:text-white"
  >
    Ausschnitt aus vergangenen Mandaten
  </h2>
  <p class="mt-3 text-base text-gray-600 dark:text-gray-300">
    Drei Blickwinkel pro Projekt: Ausgangslage, Ansatz und was davon im Alltag
    spürbar bleibt – plus der Tech-Stack für Ihr Audit.
  </p>
</div>

<div
  id="case-studies-carousel"
  data-total-slides={totalSlides}
  role="region"
  aria-roledescription="Karussell"
  aria-label={`Case Studies, Seite 1 von ${totalSlides}`}
>
  {
    Array.from({ length: totalSlides }).map((_, slideIndex) => {
      const startIdx = slideIndex * 2;
      const slideStudies = caseStudies.slice(startIdx, startIdx + 2);
      return (
        <div
          class="case-study-slide grid grid-cols-1 gap-8 md:grid-cols-2 md:gap-12"
          role="group"
          aria-roledescription="Folie"
          aria-label={`Seite ${slideIndex + 1} von ${totalSlides}`}
          data-slide-index={slideIndex}
          style={slideIndex === 0 ? "" : "display: none;"}
        >
          {slideStudies.map((caseStudy) => (
            <article class="flex flex-col justify-between rounded-xl border border-gray-200 bg-white p-6 shadow-sm transition-all duration-300 hover:shadow-md hover:border-brand-blue/30 dark:border-white/10 dark:bg-white/5 dark:hover:border-brand-blue/50 dark:hover:bg-white/10">
              <div>
                <div class="flex items-center justify-between mb-4">
                  <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400">
                    {caseStudy.timeframe}
                  </p>
                  <div class="h-px flex-1 bg-gray-200 dark:bg-white/10 mx-4" />
                </div>

                <h3 class="text-xl font-bold text-gray-900 dark:text-white">
                  {caseStudy.company}
                </h3>
                <p class="text-sm text-brand-blue font-medium mt-1">
                  {caseStudy.role}
                </p>
                <p class="mt-4 text-sm font-medium text-gray-900 dark:text-gray-200 border-l-2 border-brand-gold pl-3">
                  {caseStudy.mission}
                </p>

                <div class="mt-6 space-y-4 text-sm text-gray-600 dark:text-gray-300">
                  <div>
                    <p class="font-semibold text-gray-900 dark:text-white text-xs uppercase tracking-wider mb-1">
                      Ausgangssituation
                    </p>
                    <p class="leading-relaxed">{caseStudy.situation}</p>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-900 dark:text-white text-xs uppercase tracking-wider mb-1">
                      Ansatz
                    </p>
                    <p class="leading-relaxed">{caseStudy.approach}</p>
                  </div>
                  <div>
                    <p class="font-semibold text-gray-900 dark:text-white text-xs uppercase tracking-wider mb-1">
                      Ergebnis
                    </p>
                    <p class="leading-relaxed text-gray-900 dark:text-white font-medium">
                      {caseStudy.result}
                    </p>
                  </div>
                </div>
              </div>

              <div class="mt-8 pt-6 border-t border-gray-100 dark:border-white/5">
                <p class="text-xs uppercase tracking-wide text-gray-500 dark:text-gray-400 mb-2">
                  Stack
                </p>
                <div class="flex flex-wrap gap-2">
                  {caseStudy.stack.split(",").map((tech) => (
                    <span class="inline-flex items-center rounded-md bg-gray-50 px-2 py-1 text-xs font-medium text-gray-600 ring-1 ring-inset ring-gray-500/10 dark:bg-white/5 dark:text-gray-300 dark:ring-white/20">
                      {tech.trim()}
                    </span>
                  ))}
                </div>
              </div>
            </article>
          ))}
        </div>
      );
    })
  }
</div>

<div
  class="mt-8 flex flex-col gap-4 md:flex-row md:items-center md:justify-between"
  role="group"
  aria-label="Karussell-Navigation"
>
  <div
    class="space-x-2"
    id="carousel-dots"
    role="tablist"
    aria-label="Folien auswählen"
  >
    {
      Array.from({ length: totalSlides }).map((_, index) => (
        <button
          type="button"
          role="tab"
          class={`carousel-dot h-2 w-2 rounded-full focus:outline-hidden focus:ring-2 focus:ring-brand-blue focus:ring-offset-2 dark:focus:ring-offset-brand-dark transition-colors duration-200 ${index === 0 ? "bg-brand-blue w-4" : "bg-gray-300 dark:bg-gray-700 hover:bg-gray-400 dark:hover:bg-gray-600"}`}
          data-slide={index}
          aria-label={`Seite ${index + 1} von ${totalSlides}`}
          aria-selected={index === 0 ? "true" : "false"}
          tabindex={index === 0 ? 0 : -1}
        />
      ))
    }
  </div>

  <div class="flex flex-wrap gap-4 md:items-center">
    <button
      id="toggle-autoplay"
      aria-pressed="false"
      class="rounded-full border border-gray-300 px-4 py-2 text-sm font-semibold text-gray-700 hover:bg-gray-50 hover:text-gray-900 focus:outline-hidden focus:ring-2 focus:ring-brand-blue focus:ring-offset-2 dark:border-white/10 dark:text-gray-300 dark:hover:bg-white/5 dark:hover:text-white dark:focus:ring-offset-brand-dark transition-colors"
    >
      Auto-Play pausieren
    </button>

    <div class="flex gap-x-4">
      <button
        id="prev-slide"
        aria-label="Vorherige Cases"
        class="rounded-full border border-gray-300 p-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 focus:outline-hidden focus:ring-2 focus:ring-brand-blue focus:ring-offset-2 dark:border-white/10 dark:text-gray-400 dark:hover:bg-white/5 dark:hover:text-white dark:focus:ring-offset-brand-dark transition-colors"
      >
        <span class="sr-only">Vorherige</span>
        <svg
          class="h-5 w-5"
          viewBox="0 0 20 20"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            fill-rule="evenodd"
            d="M15 10a1 1 0 01-1 1H7.414l3.293 3.293a1 1 0 01-1.414 1.414l-5-5a1 1 0 010-1.414l5-5a1 1 0 111.414 1.414L7.414 9H14a1 1 0 011 1z"
            clip-rule="evenodd"></path>
        </svg>
      </button>

      <button
        id="next-slide"
        aria-label="Nächste Cases"
        class="rounded-full border border-gray-300 p-2 text-gray-600 hover:bg-gray-50 hover:text-gray-900 focus:outline-hidden focus:ring-2 focus:ring-brand-blue focus:ring-offset-2 dark:border-white/10 dark:text-gray-400 dark:hover:bg-white/5 dark:hover:text-white dark:focus:ring-offset-brand-dark transition-colors"
      >
        <span class="sr-only">Nächste</span>
        <svg
          class="h-5 w-5"
          viewBox="0 0 20 20"
          fill="currentColor"
          aria-hidden="true"
        >
          <path
            fill-rule="evenodd"
            d="M5 10a1 1 0 011-1h6.586l-3.293-3.293a1 1 0 011.414-1.414l5 5a1 1 0 010 1.414l-5 5a1 1 0 01-1.414-1.414L12.586 11H6a1 1 0 01-1-1z"
            clip-rule="evenodd"></path>
        </svg>
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const carousel = document.getElementById("case-studies-carousel");
    if (!carousel) return;

    const totalSlides = parseInt(
      carousel.getAttribute("data-total-slides") || "1",
    );
    const slides = carousel.querySelectorAll<HTMLElement>(".case-study-slide");
    const dots = document.querySelectorAll<HTMLElement>(".carousel-dot");
    const prevBtn = document.getElementById("prev-slide");
    const nextBtn = document.getElementById("next-slide");
    const toggleBtn = document.getElementById("toggle-autoplay");

    const prefersReducedMotion = window.matchMedia(
      "(prefers-reduced-motion: reduce)",
    ).matches;

    let currentSlide = 0;
    let userPaused = prefersReducedMotion;
    // Respects user's motion preferences to avoid triggering vestibular disorders
    let isPaused = prefersReducedMotion;
    let interval: ReturnType<typeof setInterval> | null = null;

    const updateCarouselLabel = (index: number) => {
      carousel.setAttribute(
        "aria-label",
        `Case Studies, Seite ${index + 1} von ${totalSlides}`,
      );
    };

    const showSlide = (index: number) => {
      slides.forEach((slide, i) => {
        slide.style.display = i === index ? "" : "none";
      });
      dots.forEach((dot, i) => {
        if (i === index) {
          dot.classList.remove("bg-gray-300", "dark:bg-gray-700", "w-2");
          dot.classList.add("bg-brand-blue", "w-4");
          dot.setAttribute("aria-selected", "true");
          dot.setAttribute("tabindex", "0");
        } else {
          dot.classList.remove("bg-brand-blue", "w-4");
          dot.classList.add("bg-gray-300", "dark:bg-gray-700", "w-2");
          dot.setAttribute("aria-selected", "false");
          dot.setAttribute("tabindex", "-1");
        }
      });
      currentSlide = index;
      updateCarouselLabel(index);
    };

    const nextSlide = () => {
      showSlide((currentSlide + 1) % totalSlides);
    };

    const prevSlide = () => {
      showSlide((currentSlide - 1 + totalSlides) % totalSlides);
    };

    const stopAutoplay = () => {
      if (interval) {
        clearInterval(interval);
        interval = null;
      }
    };

    const startAutoplay = () => {
      stopAutoplay();
      interval = setInterval(() => {
        if (!isPaused) nextSlide();
      }, 5000);
    };

    const updateToggleUI = () => {
      if (!toggleBtn) return;
      toggleBtn.textContent = isPaused
        ? "Auto-Play fortsetzen"
        : "Auto-Play pausieren";
      toggleBtn.setAttribute("aria-pressed", isPaused.toString());
    };

    if (toggleBtn && prefersReducedMotion) {
      updateToggleUI();
    }

    prevBtn?.addEventListener("click", () => {
      prevSlide();
    });

    nextBtn?.addEventListener("click", () => {
      nextSlide();
    });

    toggleBtn?.addEventListener("click", () => {
      userPaused = !userPaused;
      isPaused = userPaused;
      updateToggleUI();
      if (!isPaused) {
        startAutoplay();
      }
    });

    dots.forEach((dot, index) => {
      dot.addEventListener("click", () => {
        showSlide(index);
      });

      dot.addEventListener("keydown", (e: KeyboardEvent) => {
        if (e.key === "ArrowRight" || e.key === "ArrowDown") {
          e.preventDefault();
          const nextIndex = (index + 1) % totalSlides;
          showSlide(nextIndex);
          (dots[nextIndex] as HTMLElement).focus();
        } else if (e.key === "ArrowLeft" || e.key === "ArrowUp") {
          e.preventDefault();
          const prevIndex = (index - 1 + totalSlides) % totalSlides;
          showSlide(prevIndex);
          (dots[prevIndex] as HTMLElement).focus();
        } else if (e.key === "Home") {
          e.preventDefault();
          showSlide(0);
          (dots[0] as HTMLElement).focus();
        } else if (e.key === "End") {
          e.preventDefault();
          showSlide(totalSlides - 1);
          (dots[totalSlides - 1] as HTMLElement).focus();
        }
      });
    });

    const handleVisibility = () => {
      if (document.hidden) {
        isPaused = true;
        stopAutoplay();
        updateToggleUI();
        return;
      }
      // Only resume if the user did not explicitly pause and motion is allowed
      if (!userPaused && !prefersReducedMotion) {
        isPaused = false;
        updateToggleUI();
        startAutoplay();
      }
    };

    document.addEventListener("visibilitychange", handleVisibility);
    window.addEventListener("blur", handleVisibility);
    window.addEventListener("focus", handleVisibility);
    window.addEventListener("beforeunload", stopAutoplay);

    if (!prefersReducedMotion) {
      startAutoplay();
    }
  });
</script>
