---
interface Testimonial {
    quote: string;
    role: string;
    company: string;
    initial: string;
    avatarColor: "neutral" | "indigo" | "emerald" | "amber";
}

const testimonials: Testimonial[] = [
    {
        quote: `„Durch die automatisierten Workflows sparen wir täglich mehrere Stunden. Die Umsetzung war schnell und fachlich auf sehr hohem Niveau. Endlich kümmert sich das Team wieder um Kunden statt um Excel."`,
        role: "Leitung Operations",
        company: "Mittelständisches Unternehmen",
        initial: "M",
        avatarColor: "neutral",
    },
    {
        quote: `„Der Mix aus technischer Tiefe und pragmatischer Umsetzung hat uns überzeugt. Kein 'Consulting-Bla-Bla', sondern funktionierende Lösungen in Rekordzeit."`,
        role: "Geschäftsführung",
        company: "Digital-Agentur (DACH)",
        initial: "A",
        avatarColor: "indigo",
    },
    {
        quote: `„Wir konnten unsere Lead-Qualifizierung komplett automatisieren. Das Ergebnis: 30% mehr qualifizierte Termine und ein deutlich entspannteres Sales-Team."`,
        role: "Head of Sales",
        company: "SaaS Scale-up",
        initial: "S",
        avatarColor: "emerald",
    },
    {
        quote: `„Die n8n-Integration hat unsere internen Datensilos endlich aufgebrochen. Alle Tools sprechen jetzt miteinander – das ist echte digitale Transformation."`,
        role: "CTO",
        company: "E-Commerce Brand",
        initial: "T",
        avatarColor: "amber",
    },
];

const avatarColorClasses: Record<Testimonial["avatarColor"], string> = {
    neutral: "bg-gray-700 text-white",
    indigo: "bg-indigo-600 text-white",
    emerald: "bg-emerald-600 text-white",
    amber: "bg-amber-500 text-white",
};
---

<section class="relative overflow-hidden bg-white py-24 dark:bg-gray-950">
    <div class="container relative mx-auto max-w-6xl px-4">
        <h2
            class="mb-16 text-center text-3xl font-bold text-gray-900 dark:text-white md:text-4xl"
        >
            Was andere sagen
        </h2>

        <div class="group relative">
            <button
                id="prevBtn"
                class="absolute left-0 top-1/2 z-10 -translate-x-4 -translate-y-1/2 rounded-full bg-gray-900 p-3 text-white opacity-0 shadow-lg transition-opacity hover:bg-gray-700 disabled:opacity-0 group-hover:opacity-100 dark:bg-gray-100 dark:text-gray-900 dark:hover:bg-gray-300"
                aria-label="Vorheriges Testimonial"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M15 19l-7-7 7-7"></path>
                </svg>
            </button>

            <button
                id="nextBtn"
                class="absolute right-0 top-1/2 z-10 -translate-y-1/2 translate-x-4 rounded-full bg-gray-900 p-3 text-white opacity-0 shadow-lg transition-opacity hover:bg-gray-700 disabled:opacity-0 group-hover:opacity-100 dark:bg-gray-100 dark:text-gray-900 dark:hover:bg-gray-300"
                aria-label="Nächstes Testimonial"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    class="h-6 w-6"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                >
                    <path
                        stroke-linecap="round"
                        stroke-linejoin="round"
                        stroke-width="2"
                        d="M9 5l7 7-7 7"></path>
                </svg>
            </button>

            <div
                id="slider"
                class="scrollbar-hide flex snap-x snap-mandatory gap-8 overflow-x-auto scroll-smooth pb-8"
                style="scrollbar-width: none; -ms-overflow-style: none;"
            >
                {
                    testimonials.map((testimonial) => (
                        <div class="flex min-w-full snap-center md:min-w-[calc(50%-1rem)]">
                            <div class="flex-1 rounded-2xl border border-gray-200 bg-white p-8 shadow-lg transition-all hover:shadow-xl dark:border-gray-700 dark:bg-gray-900">
                                {/* Star rating */}
                                <div class="mb-4 flex text-amber-400">
                                    {[...Array(5)].map(() => (
                                        <svg
                                            class="h-5 w-5 fill-current"
                                            viewBox="0 0 24 24"
                                        >
                                            <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                                        </svg>
                                    ))}
                                </div>

                                <p class="mb-6 text-lg italic leading-relaxed text-gray-600 dark:text-gray-300">
                                    {testimonial.quote}
                                </p>

                                <div class="flex items-center gap-4">
                                    <div
                                        class={`flex h-12 w-12 items-center justify-center rounded-full ${avatarColorClasses[testimonial.avatarColor]}`}
                                    >
                                        <span class="text-xl">
                                            {testimonial.initial}
                                        </span>
                                    </div>
                                    <div>
                                        <div class="font-bold text-gray-900 dark:text-white">
                                            {testimonial.role}
                                        </div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">
                                            {testimonial.company}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))
                }
            </div>

            <div class="mt-4 flex justify-center gap-2">
                {
                    testimonials.map((_, index) => (
                        <button
                            class="dot-indicator h-3 w-3 rounded-full bg-gray-300 transition-colors hover:bg-indigo-600 data-[active=true]:bg-indigo-600 dark:bg-gray-600 dark:hover:bg-indigo-400 dark:data-[active=true]:bg-indigo-400"
                            data-index={index}
                            aria-label={`Gehe zu Testimonial ${index + 1}`}
                        />
                    ))
                }
            </div>
        </div>
    </div>
</section>

<script>
    const initSlider = () => {
        const slider = document.getElementById("slider");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const dots = document.querySelectorAll(".dot-indicator");

        if (!slider || !prevBtn || !nextBtn) return;

        const updateButtons = () => {
            const isStart = slider.scrollLeft <= 10;
            const isEnd =
                Math.abs(
                    slider.scrollWidth - slider.clientWidth - slider.scrollLeft,
                ) <= 10;

            (prevBtn as HTMLButtonElement).disabled = isStart;
            (nextBtn as HTMLButtonElement).disabled = isEnd;
        };

        const updateDots = () => {
            const scrollLeft = slider.scrollLeft;
            const cardWidth =
                slider.clientWidth / (window.innerWidth >= 768 ? 2 : 1);
            const index = Math.round(scrollLeft / cardWidth);

            const currentDots = document.querySelectorAll(".dot-indicator");
            currentDots.forEach((dot, i) => {
                if (i === index) {
                    dot.setAttribute("data-active", "true");
                } else {
                    dot.setAttribute("data-active", "false");
                }
            });
        };

        const scroll = (direction: "left" | "right") => {
            const cardWidth = slider.firstElementChild?.clientWidth || 0;
            const gap = 32;
            const scrollAmount = cardWidth + gap;

            if (direction === "left") {
                slider.scrollBy({ left: -scrollAmount, behavior: "smooth" });
            } else {
                slider.scrollBy({ left: scrollAmount, behavior: "smooth" });
            }
        };

        // Remove old listeners to prevent duplicates if re-initialized
        const newPrevBtn = prevBtn.cloneNode(true);
        const newNextBtn = nextBtn.cloneNode(true);
        prevBtn.parentNode?.replaceChild(newPrevBtn, prevBtn);
        nextBtn.parentNode?.replaceChild(newNextBtn, nextBtn);

        newPrevBtn.addEventListener("click", () => scroll("left"));
        newNextBtn.addEventListener("click", () => scroll("right"));

        slider.addEventListener("scroll", () => {
            updateButtons();
            updateDots();
        });

        window.addEventListener("resize", () => {
            updateButtons();
            updateDots();
        });

        updateButtons();
        updateDots();

        dots.forEach((dot, index) => {
            const newDot = dot.cloneNode(true);
            dot.parentNode?.replaceChild(newDot, dot);

            newDot.addEventListener("click", () => {
                const cardWidth = slider.firstElementChild?.clientWidth || 0;
                const gap = 32;
                const scrollAmount = (cardWidth + gap) * index;
                slider.scrollTo({ left: scrollAmount, behavior: "smooth" });
            });
        });
    };

    initSlider();
    document.addEventListener("astro:page-load", initSlider);
</script>
