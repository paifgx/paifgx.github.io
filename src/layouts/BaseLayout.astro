---
import Header from "../components/Header.vue";
import Footer from "../components/Footer.astro";
import "../styles/global.css";

const siteOrigin = "https://garten.ai";
const currentPath = Astro.url.pathname;
const canonicalURL = new URL(Astro.url.pathname, siteOrigin);

const {
  classDefintion,
  title,
  description,
  type = "website",
  image = "/og-image.png",
  noindex = false,
} = Astro.props;

const defaultTitle =
  "Patrik Garten · AI Solution Architect & Software Engineer";
const defaultDescription =
  "Freelance AI Solution Architect, Software Engineer & IT-Dozent. End-to-end KI-Architekturen – von klassischen ML-Systemen bis zu LLM-/GenAI-Plattformen – sowie Security-by-Design für regulierte DACH-Unternehmen.";

const pageTitle = title ? `${title} · Patrik Garten` : defaultTitle;
const pageDescription = description || defaultDescription;
const ogImageURL = new URL(image, siteOrigin).href;
const mainClass = classDefintion ?? "";

// Build breadcrumb data based on path
const pathSegments = currentPath.split('/').filter(Boolean);
const pathNames: Record<string, string> = {
  about: "Werdegang",
  service: "Dienstleistungen",
  contact: "Kontakt",
  impress: "Impressum",
  privacy: "Datenschutz",
};

const breadcrumbItems = [
  { "@type": "ListItem", position: 1, name: "Startseite", item: siteOrigin }
];

pathSegments.forEach((segment, index) => {
  const url = `${siteOrigin}/${pathSegments.slice(0, index + 1).join('/')}/`;
  const name = pathNames[segment] || segment;
  breadcrumbItems.push({
    "@type": "ListItem",
    position: index + 2,
    name,
    item: url,
  });
});

const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Person",
      name: "Patrik Garten",
      jobTitle: "AI Solution Architect & Software Engineer",
      url: canonicalURL.href,
      sameAs: [
        "https://www.linkedin.com/in/paifgx",
        "https://www.garten.ai",
        "mailto:info@garten.ai",
      ],
      worksFor: {
        "@type": "Organization",
        name: "Patrik Garten AI Development",
      },
    },
    {
      "@type": "ProfessionalService",
      name: "Patrik Garten AI Development",
      url: siteOrigin,
      image: ogImageURL,
      areaServed: ["Deutschland", "Österreich", "Schweiz"],
      availableLanguage: ["de", "en"],
      serviceType: [
        "AI Solution Architecture",
        "Generative AI Enablement",
        "Software Engineering",
      ],
      priceRange: "€€€",
      address: {
        "@type": "PostalAddress",
        streetAddress: "Phönixstraße 30",
        postalCode: "44263",
        addressLocality: "Dortmund",
        addressCountry: "DE",
      },
      telephone: "+49 1516 4587494",
      email: "info@garten.ai",
    },
    // Breadcrumbs for subpages
    ...(pathSegments.length > 0 ? [{
      "@type": "BreadcrumbList",
      itemListElement: breadcrumbItems,
    }] : []),
  ],
};
---

<!doctype html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{pageTitle}</title>
    <meta name="description" content={pageDescription} />
    <link rel="canonical" href={canonicalURL} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Author & Generator -->
    <meta name="author" content="Patrik Garten" />
    <meta name="generator" content={Astro.generator} />

    <!-- Language alternates -->
    <link rel="alternate" hreflang="de" href={canonicalURL} />
    <link rel="alternate" hreflang="x-default" href={canonicalURL} />

    <!-- Open Graph -->
    <meta property="og:title" content={pageTitle} />
    <meta property="og:description" content={pageDescription} />
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:locale" content="de_DE" />
    <meta property="og:site_name" content="GARTEN.ai" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={pageTitle} />
    <meta name="twitter:description" content={pageDescription} />
    <meta name="twitter:image" content={ogImageURL} />
    <meta name="twitter:creator" content="@paifgx" />

    <!-- Theme & Icons -->
    <meta name="color-scheme" content="light dark" />
    <meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff" />
    <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#030712" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />

    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://images.unsplash.com" />
    <link rel="dns-prefetch" href="https://images.unsplash.com" />

    <!-- Structured Data -->
    <script
      type="application/ld+json"
      is:inline
      set:html={JSON.stringify(structuredData)}
    />
    <script is:inline>
      (() => {
        const storageKey = "theme-preference";
        const query = "(prefers-color-scheme: dark)";
        const mediaQuery = window.matchMedia(query);

        const getStoredTheme = () => {
          try {
            const stored = window.localStorage.getItem(storageKey);
            return stored === "dark" || stored === "light" ? stored : null;
          } catch {
            return null;
          }
        };

        const applyTheme = (theme) => {
          const isDark = theme === "dark";
          document.documentElement.classList.toggle("dark", isDark);
          document.documentElement.style.colorScheme = theme;
        };

        const resolveTheme = () =>
          getStoredTheme() ?? (mediaQuery.matches ? "dark" : "light");

        applyTheme(resolveTheme());

        const handleSystemChange = (event) => {
          if (getStoredTheme()) return;
          applyTheme(event.matches ? "dark" : "light");
        };

        mediaQuery.addEventListener("change", handleSystemChange);

        window.addEventListener("storage", (event) => {
          if (event.key !== storageKey) return;
          if (!event.newValue) {
            applyTheme(mediaQuery.matches ? "dark" : "light");
            return;
          }
          applyTheme(event.newValue === "dark" ? "dark" : "light");
        });
      })();
    </script>
  </head>
  <body
    class="min-h-screen bg-gray-50 text-gray-900 antialiased dark:bg-gray-950 dark:text-gray-100"
  >
    <Header currentPath={currentPath} client:load />

    <main class={mainClass}>
      <slot />
    </main>

    <Footer />
  </body>
</html>
